name: Cypress Tests
env:
  VERCEL_ORG_ID: "${{ secrets.VERCEL_ORG_ID }}"
  VERCEL_PROJECT_ID: "${{ secrets.VERCEL_PROJECT_ID }}"
  GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

on: [pull_request]
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  cypress-run:
    runs-on: ubuntu-latest
    environment: preview
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Install Vercel CLI
        run: npm install --global vercel@latest
      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
      - name: Cypress install
        uses: cypress-io/github-action@v4.2.0 # use the explicit version number
        with:
          # Disable running of tests within install job
          runTests: false
          build: npm run build
      - name: E2E on Chrome
        uses: cypress-io/github-action@v4.2.0
        with:
          browser: chrome
          start: npm run start
          wait-on: "http://localhost:3000"
      - name: Uploading Screenshots
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: "cypress-screenshots"
          path: cypress/screenshots
      # Test run video was always captured, so this action uses "always()" condition
      - name: Uploading Videos
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: cypress-videos
          path: cypress/videos
